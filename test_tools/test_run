#!/bin/bash -e

target="$1"
test_dir="${target}_test_dir"

# Set default trap
trap 'echo "$1: test CRASHED" >&2' 0

# Create test directory, enter it
if [ -r "$test_dir" ]; then
	chmod -R u+rwx "$test_dir"
fi
rm -rf "$test_dir" && mkdir "$test_dir" && tar --strip-components 1 --same-owner -x -z -f test_dir.tar.gz -C "$test_dir" && cd "$test_dir" || exit 1

# Get environment variables
. ./test_env

expected="../$target".exp
output="../$target".all
success="../$target".done
executable="../${target}_test"

# Set path to access test scripts in priority
OLD_PATH=$PATH
export PATH=../../../test_tools:$PATH

# Cleanup previous attempt, if any
rm -f "$output" "$success"

# Run
"$executable" 2>&1 | sed "s/\r/\\\r\n/g" > "$output"

# Revert path
PATH=$OLD_PATH

# Update default trap
trap 'echo "$1: test FAILED" >&2' 0

# Check
diff -q "$expected" "$output" > /dev/null

# Cleanup
rm -f "$output"

# Success
touch "$success"

# Update default trap
trap 'echo "$1: test passed"' 0

exit 0
