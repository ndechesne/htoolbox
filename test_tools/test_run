#!/bin/sh

target="$1"
expected="$target".exp
output="$target".all
executable="$target"_test

# Set path to access test scripts in priority
OLD_PATH=$PATH
export PATH=../../test_tools:$PATH

# Cleanup previous attempt, if any
rm -f $output

# Setup
if ! test_setup; then
	echo "Cannot setup test environment"
	exit 1
fi

# Run
if ! ./$executable > $output 2>&1; then
	exit 2
fi

# Revert path
PATH=$OLD_PATH

# Check
if ! diff -q $expected $output > /dev/null; then
	echo "$target: error: test output is different from expected" >&2
	exit 3
fi

# Cleanup
rm -f $output
exit 0
