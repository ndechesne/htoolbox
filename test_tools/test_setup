#!/bin/sh

# Set mask
umask 0022

# Dir names
CONFIGDIR="etc"

TESTDIR="test1"
TESTDIR2="test2"
TESTDIRCIFS="test_cifs"
TESTDIRNFS="test_nfs"
TESTDIRUSER="test_user"
TESTDBDIR="test_db"
TESTRESTORE="test_r"

ROOTDIRNFS="/home/User"

# Create given directory, enter it
if [ -n "$1" ]; then
  rm -rf "$1" && mkdir "$1" && cd "$1" || exit 1
else
  # Clean
  rm -rf "$CONFIGDIR"
  rm -rf "$TESTDBDIR"
  rm -rf "$TESTDIR"
  rm -rf "$TESTDIR2"
  rm -rf "$TESTDIRCIFS"
  rm -rf "$TESTDIRNFS"
  rm -rf "$TESTDIRUSER"
  rm -rf "$TESTRESTORE"
fi

# Create environment file
cat << EOF >> test_env
export CONFIGDIR="$CONFIGDIR"
export TESTDIR="$TESTDIR"
export TESTDIR2="$TESTDIR2"
export TESTDIRCIFS="$TESTDIRCIFS"
export TESTDIRNFS="$TESTDIRNFS"
export TESTDIRUSER="$TESTDIRUSER"
export TESTDBDIR="$TESTDBDIR"
export TESTRESTORE="$TESTRESTORE"
export ROOTDIRNFS="$ROOTDIRNFS"
EOF

# Test bench
mkdir "$TESTDIR"
mkdir "$TESTDIR/testdir"
echo "Hello world!" > "$TESTDIR/testfile"
touch -d 20061022 "$TESTDIR/testfile"
touch "$TESTDIR/testfile~"
ln -s "testfile" "$TESTDIR/testlink"
mkfifo "$TESTDIR/testpipe"

# Filters test
mkdir "$TESTDIR/subdir"
echo "Hello Moon!" > "$TESTDIR/subdir/testfile"
touch "$TESTDIR/subdir/testfile1"
echo "Hello Moon!" > "$TESTDIR/subdir/testfile2"
touch "$TESTDIR/test space"
mkdir "$TESTDIR/dir space"
touch "$TESTDIR/dir space/file space"

# Big file
dd if=/dev/zero of=test1/big_file bs=1M count=10 status=noxfer 2> /dev/null

# CVS test
CVSDIR="$TESTDIR/cvs"
mkdir "$CVSDIR"
touch "$CVSDIR/filemod.o"
touch "$CVSDIR/filenew.c"
touch "$CVSDIR/fileoth"
touch -d "Wed Oct  4 18:04:40 UTC 2006" "$CVSDIR/fileutd.h"
mkdir "$CVSDIR/dirbad"
touch "$CVSDIR/dirbad/fileoth"
touch "$CVSDIR/dirbad/fileutd"
mkdir "$CVSDIR/diroth"
mkdir "$CVSDIR/dirutd"
touch "$CVSDIR/dirutd/fileoth"
touch "$CVSDIR/dirutd/fileutd"
mkdir "$CVSDIR/dirutd/CVS"
cat << EOF > "$CVSDIR/dirutd/CVS/Entries"
/fileutd/1.2/Wed Oct  4 18:04:40 2006//
D
EOF
echo "Some root" > "$CVSDIR/dirutd/CVS/Root"
echo "Some thing" > "$CVSDIR/dirutd/CVS/Whatever"
mkdir "$CVSDIR/CVS"
cat << EOF > "$CVSDIR/CVS/Entries"
/filenew.c/0/dummy timestamp//
/filemod.o/1.1/Mon Oct  2 16:27:11 2006//D2007.12.16.23.00.00
/fileutd.h/1.2/Wed Oct  4 18:04:40 2006//
D/dirbad////
D/dirutd////
EOF
echo "Some other root" > "$CVSDIR/CVS/Root"
echo "Some other thing" > "$CVSDIR/CVS/Whatever"
mkdir "$CVSDIR/CVS/Wherever"
touch "$CVSDIR/CVS/Wherever/Whichever"

# Subversion test
SVNDIR="$TESTDIR/svn"
mkdir "$SVNDIR"
touch "$SVNDIR/filemod.o"
touch "$SVNDIR/filenew.c"
touch "$SVNDIR/fileoth"
touch "$SVNDIR/fileutd.h"
mkdir "$SVNDIR/dirbad"
touch "$SVNDIR/dirbad/fileoth"
touch "$SVNDIR/dirbad/fileutd"
mkdir "$SVNDIR/diroth"
mkdir "$SVNDIR/dirutd"
touch "$SVNDIR/dirutd/fileoth"
touch "$SVNDIR/dirutd/fileutd"
mkdir "$SVNDIR/dirutd/.svn"
cat << EOF > "$SVNDIR/dirutd/.svn/entries"
C      fileutd
?      fileoth
EOF
echo "Some format" > "$SVNDIR/dirutd/.svn/format"
echo "Something" > "$SVNDIR/dirutd/.svn/whatever"
mkdir "$SVNDIR/.svn"
cat << EOF > "$SVNDIR/.svn/entries"
A      filenew.c
M      filemod.o
I      fileoth
 M     dirbad
?      diroth
EOF
echo "Some other format" > "$SVNDIR/.svn/format"
echo "Someotherthing" > "$SVNDIR/.svn/whatever"
mkdir "$SVNDIR/.svn/wherever"
touch "$SVNDIR/.svn/wherever/whichever"

# Bazaar test
BZRDIR="$TESTDIR/bzr"
mkdir "$BZRDIR"
touch "$BZRDIR/filemod.o"
touch "$BZRDIR/filenew.c"
touch "$BZRDIR/fileoth"
touch "$BZRDIR/fileutd.h"
mkdir "$BZRDIR/dirbad"
touch "$BZRDIR/dirbad/fileoth"
touch "$BZRDIR/dirbad/fileutd"
mkdir "$BZRDIR/diroth"
mkdir "$BZRDIR/dirutd"
touch "$BZRDIR/dirutd/fileoth"
touch "$BZRDIR/dirutd/fileutd"
BZROLDDIR=`pwd`
cd "$BZRDIR"
bzr init
bzr -q add filemod.o
bzr -q add fileutd.h
bzr -q add dirbad
bzr -q add dirbad/fileutd
bzr -q add dirutd
bzr -q add dirutd/fileutd
bzr -q commit -m "Initial import"
bzr -q add filenew.c
echo "bzr 1" > filemod.o
cd "$BZROLDDIR"

# Multiple backup
mkdir "$TESTDIR2"
mkdir "$TESTDIR2/testdir"
dd if=/dev/zero of="$TESTDIR2/testfile" bs=142 count=1024 2> /dev/null
touch -t 200610221134.56 "$TESTDIR2/testfile"
dd if=/dev/zero of="$TESTDIR2/testfile~" bs=512 count=1024 2> /dev/null
dd if=/dev/zero of="$TESTDIR2/testfile2" bs=253 count=1024 2> /dev/null
ln -s "testfile" "$TESTDIR2/testlink"

# CIFS test
mkdir -p "$TESTDIRCIFS/Backup"
mkdir -p "$TESTDIRCIFS/Test"
touch "$TESTDIRCIFS/Test/File.TXT"
mkdir -p "$TESTDIRCIFS/Test/Dir"
echo 1 > "$TESTDIRCIFS/Test/Dir/a File.TXT"
echo 2 > "$TESTDIRCIFS/Test/Dir/another File.TXT"
cat << EOF > "$TESTDIRCIFS/Backup/Backup.LST"
subset 'xp'
# Ends in \", but should not fail
path "C:\Test\"
EOF

# NFS test
mkdir -p "$TESTDIRNFS/test"
touch "$TESTDIRNFS/test/File2.txt"
mkdir -p "$TESTDIRNFS/test/dir"
echo 3 > "$TESTDIRNFS/test/dir/file3.txt"
mkdir -p "$TESTDIRNFS/test2"
touch "$TESTDIRNFS/test2/File3.txt"
touch "$TESTDIRNFS/test2/File4.txt"
cat << EOF > "$TESTDIRNFS/hbackup.list"
path "$ROOTDIRNFS/test/"
EOF

# User-mode test
mkdir -p "$TESTDIRUSER/testuser"
echo 10 > "$TESTDIRUSER/testuser/f1.txt"
mkdir -p "$TESTDIRUSER/testuser/subdir"
echo 20 > "$TESTDIRUSER/testuser/subdir/f2.txt"
mkdir -p "$TESTDIRUSER/testuser/subdir2"
echo 30 > "$TESTDIRUSER/testuser/subdir2/f3.txt"
echo 40 > "$TESTDIRUSER/testuser/subdir2/f4.txt"
mkdir -p "$TESTDIRUSER/.hbackup"
cat << EOF > "$TESTDIRUSER/.hbackup/config"
path "~/testuser/"
EOF

# Restore
mkdir -p "$TESTRESTORE"

# Server config
mkdir "$CONFIGDIR"
cat << EOF > "$CONFIGDIR/hbackup.conf"
db "$TESTDBDIR"
trash 1
EOF
echo "\r" >> "$CONFIGDIR/hbackup.conf"
cat << EOF >> "$CONFIGDIR/hbackup.conf"
filter all backup
condition type file
condition path_end ~

filter any test_or
condition filter backup
condition !size< 1000

client myClient
protocol nfs
hostname myClient
config $ROOTDIRNFS/hbackup.list

client other
protocol ssh
hostname otherClient
config /home/backup/Backup.list

client myhost
protocol file
hostname myhost.mynetwork.lan
config "$CONFIGDIR/localhost.list"
expire 1

client client xp
protocol smb
option username Myself
option password flesyM
option nocase
hostname myClient
config "C:\Backup\Backup.LST"
EOF

# Client config
cat << EOF > "$CONFIGDIR/localhost.list"
# This is a comment
filter and subdir
condition path_start subdir
condition !size< 100
EOF
echo "\r" >> "$CONFIGDIR/localhost.list"
cat << EOF >> "$CONFIGDIR/localhost.list"
filter and bigfile
condition size>= 10
condition type file

expire 1

path test2//

path "test1" # should work

filter and not_object
condition !path_end ".o"

filter or to_be_ignored
condition filter subdir
condition filter backup
condition !filter not_object

ignore to_be_ignored

compress bigfile

parser cvs controlled
parser svn modified
parser bzr modified
EOF

# General config
cat << EOF > "$CONFIGDIR/general.conf"
db "$TESTDBDIR"
trash 1

filter all backup
condition type file
condition path_end ~

filter any test_or
condition filter backup
condition !size< 1000

client nfs myClient
hostname myClient
config $ROOTDIRNFS/hbackup.list

client ssh other
hostname otherClient
config /home/backup/Backup.list
# This is a comment
filter and subdir
condition path_start subdir
condition !size< 100

filter and bigfile
condition size>= 10
condition type file

expire 1

path test2//

path "test1" # should work

filter and not_object
condition !path_end ".o"

filter or to_be_ignored
condition filter subdir
condition filter backup
condition !filter not_object

ignore to_be_ignored

compress bigfile

parser cvs controlled
parser svn modified
parser bzr modified

client file myhost
hostname myhost.mynetwork.lan
config "$CONFIGDIR/localhost.list"
expire 1

client smb client
option username Myself
option password flesyM
option nocase
hostname myClient
config "C:\Backup\Backup.LST"
EOF

# Broken config
cat << EOF > "$CONFIGDIR/broken.conf"
db "$TESTDBDIR"
db blah
trash 1 2

filter all
condition type file
condition path_end ~

filter any test_or

client nfs myClient

client ssh other
hostname otherClient
hostname 192.168.0.132
option I am happy
option
config /home/backup/Backup.list
config /home/backup/Backup2.list
# This is a comment
filter and subdir
condition path_start subdir
condition !size< 100

filter and bigfile 3
condition size>= 10 yeah
condition type

expire 1
expire 2 3

path test2//

path "test1" # should work

filter and not_object
condition !path_end ".o"

filter or to_be_ignored
condition filter subdir
condition filter backup
condition !filter not_object

filter and blah

filter or


ignore to_be_ignored
ignore to_be_ignored2

compress bigfile
compress bigfile2

parser cvs controlled
parser svn modified
parser bzr modified

client file myhost
hostname myhost.mynetwork.lan
config "$CONFIGDIR/localhost.list"
expire 1

path blah
ignore  2 3
compress 4 5

client smb client
option username Myself
option password flesyM
option nocase
hostname myClient
config "C:\Backup\Backup.LST"

path "C:\Crash\"
path "C:\Crash\

path blah
ignore
compress

what_the_f...?
EOF

cd ..
tar --remove-files -c -z -f $1.tar.gz $1
